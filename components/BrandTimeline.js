const TRANSLATIONS = {
  en: {
    title: 'Brand Production Timeline',
    subtitle: 'Explore the complete production journey from raw materials to UAE delivery.',
    selectBrand: 'Select Brand',
    stages: {
      'Raw Materials': 'Raw Materials',
      'Mixing': 'Mixing',
      'Tire Building': 'Tire Building',
      'Curing': 'Curing',
      'Quality Control': 'Quality Control',
      'Export to UAE': 'Export to UAE'
    },
    // Location keywords
    locationTerms: {
      'rubber supply': 'rubber supply',
      'via': 'via',
      'corridor': 'corridor',
      'County': 'County',
      'automated production lines': 'automated production lines',
      'production lines': 'production lines',
      'curing presses': 'curing presses',
      'curing department': 'curing department',
      'curing facilities': 'curing facilities',
      'ISO-certified laboratories': 'ISO-certified laboratories',
      'inspection laboratories': 'inspection laboratories',
      'laboratories': 'laboratories',
      'verification labs': 'verification labs',
      'export compliance labs': 'export compliance labs',
      'export testing': 'export testing',
      'testing tracks': 'testing tracks',
      'plant': 'plant',
      'plants': 'plants',
      'facility': 'facility',
      'facilities': 'facilities',
      'production facility': 'production facility',
      'shared': 'shared',
      'regional': 'regional',
      'Regional': 'Regional',
      'supply chain': 'supply chain',
      'suppliers': 'suppliers',
      'approved suppliers': 'approved suppliers',
      'logistics corridor': 'logistics corridor',
      'Company-owned plantations in': 'Company-owned plantations in',
      'rubber belt': 'rubber belt',
      'imports': 'imports',
      'global QC laboratories': 'global QC laboratories',
      'Government-approved': 'Government-approved',
      'primary': 'primary',
      'departments': 'departments',
      'warehousing': 'warehousing',
      'Port': 'Port',
      'or': 'or',
      'and': 'and'
    },
    // Duration units
    durationUnits: {
      'hours': 'hours',
      'minutes': 'minutes',
      'days': 'days',
      'per tire': 'per tire'
    }
  },
  ar: {
    title: 'الجدول الزمني لإنتاج العلامات التجارية',
    subtitle: 'استكشف رحلة الإنتاج الكاملة من المواد الخام إلى التوصيل في الإمارات.',
    selectBrand: 'اختر العلامة التجارية',
    stages: {
      'Raw Materials': 'المواد الخام',
      'Mixing': 'الخلط',
      'Tire Building': 'بناء الإطارات',
      'Curing': 'المعالجة',
      'Quality Control': 'مراقبة الجودة',
      'Export to UAE': 'التصدير إلى الإمارات'
    },
    // Location keywords
    locationTerms: {
      'rubber supply': 'إمدادات المطاط',
      'via': 'عبر',
      'corridor': 'ممر',
      'County': 'مقاطعة',
      'automated production lines': 'خطوط الإنتاج الآلية',
      'production lines': 'خطوط الإنتاج',
      'curing presses': 'مكابس المعالجة',
      'curing department': 'قسم المعالجة',
      'curing facilities': 'منشآت المعالجة',
      'ISO-certified laboratories': 'مختبرات معتمدة من ISO',
      'inspection laboratories': 'مختبرات الفحص',
      'laboratories': 'مختبرات',
      'verification labs': 'مختبرات التحقق',
      'export compliance labs': 'مختبرات الامتثال للتصدير',
      'export testing': 'اختبار التصدير',
      'testing tracks': 'مسارات الاختبار',
      'plant': 'مصنع',
      'plants': 'مصانع',
      'facility': 'منشأة',
      'facilities': 'منشآت',
      'production facility': 'منشأة الإنتاج',
      'shared': 'مشتركة',
      'regional': 'إقليمية',
      'Regional': 'إقليمية',
      'supply chain': 'سلسلة التوريد',
      'suppliers': 'موردون',
      'approved suppliers': 'موردون معتمدون',
      'logistics corridor': 'ممر لوجستي',
      'Company-owned plantations in': 'مزارع الشركة في',
      'rubber belt': 'حزام المطاط',
      'imports': 'واردات',
      'global QC laboratories': 'مختبرات مراقبة الجودة العالمية',
      'Government-approved': 'معتمد حكومياً',
      'primary': 'أساسي',
      'departments': 'أقسام',
      'warehousing': 'تخزين',
      'Port': 'ميناء',
      'or': 'أو',
      'and': 'و'
    },
    // Duration units
    durationUnits: {
      'hours': 'ساعات',
      'minutes': 'دقائق',
      'days': 'أيام',
      'per tire': 'لكل إطار'
    }
  },
  fa: {
    title: 'جدول زمانی تولید برندها',
    subtitle: 'سفر کامل تولید از مواد اولیه تا تحویل در امارات را کاوش کنید.',
    selectBrand: 'انتخاب برند',
    stages: {
      'Raw Materials': 'مواد اولیه',
      'Mixing': 'اختلاط',
      'Tire Building': 'ساخت تایر',
      'Curing': 'پخت',
      'Quality Control': 'کنترل کیفیت',
      'Export to UAE': 'صادرات به امارات'
    },
    // Location keywords
    locationTerms: {
      'rubber supply': 'تامین لاستیک',
      'via': 'از طریق',
      'corridor': 'کریدور',
      'County': 'شهرستان',
      'automated production lines': 'خطوط تولید خودکار',
      'production lines': 'خطوط تولید',
      'curing presses': 'پرس‌های پخت',
      'curing department': 'بخش پخت',
      'curing facilities': 'تاسیسات پخت',
      'ISO-certified laboratories': 'آزمایشگاه‌های دارای گواهینامه ISO',
      'inspection laboratories': 'آزمایشگاه‌های بازرسی',
      'laboratories': 'آزمایشگاه‌ها',
      'verification labs': 'آزمایشگاه‌های تایید',
      'export compliance labs': 'آزمایشگاه‌های تطابق صادرات',
      'export testing': 'آزمایش صادرات',
      'testing tracks': 'مسیرهای آزمایش',
      'plant': 'کارخانه',
      'plants': 'کارخانه‌ها',
      'facility': 'تاسیسات',
      'facilities': 'تاسیسات',
      'production facility': 'تاسیسات تولید',
      'shared': 'مشترک',
      'regional': 'منطقه‌ای',
      'Regional': 'منطقه‌ای',
      'supply chain': 'زنجیره تامین',
      'suppliers': 'تامین‌کنندگان',
      'approved suppliers': 'تامین‌کنندگان تایید شده',
      'logistics corridor': 'کریدور لجستیک',
      'Company-owned plantations in': 'مزارع متعلق به شرکت در',
      'rubber belt': 'کمربند لاستیک',
      'imports': 'واردات',
      'global QC laboratories': 'آزمایشگاه‌های جهانی کنترل کیفیت',
      'Government-approved': 'تایید شده دولتی',
      'primary': 'اصلی',
      'departments': 'بخش‌ها',
      'warehousing': 'انبارداری',
      'Port': 'بندر',
      'or': 'یا',
      'and': 'و'
    },
    // Duration units
    durationUnits: {
      'hours': 'ساعت',
      'minutes': 'دقیقه',
      'days': 'روز',
      'per tire': 'به ازای هر تایر'
    }
  }
};

export async function initBrandTimeline(lang = 'en') {
  try {
    const container = document.getElementById('production-timeline');
    if (!container) return;

    const t = TRANSLATIONS[lang] || TRANSLATIONS.en;
    const isRTL = lang === 'ar' || lang === 'fa';

    const response = await fetch('/data/brandTimelines.json');
    if (!response.ok) {
      console.warn('Timeline data not available');
      return;
    }

    const timelineData = await response.json();

    // Helper function to translate location text
    function translateLocation(location, lang) {
      if (lang === 'en') return location;
      
      let translated = location;
      const terms = t.locationTerms;
      
      // Sort terms by length (longest first) to avoid partial replacements
      const sortedTerms = Object.keys(terms).sort((a, b) => b.length - a.length);
      
      for (const term of sortedTerms) {
        const regex = new RegExp(term, 'gi');
        translated = translated.replace(regex, terms[term]);
      }
      
      return translated;
    }

    // Helper function to translate duration text
    function translateDuration(duration, lang) {
      if (lang === 'en' || !duration) return duration;
      
      let translated = duration;
      const units = t.durationUnits;
      
      // Translate duration units while preserving numbers
      for (const unit in units) {
        const regex = new RegExp(unit, 'gi');
        translated = translated.replace(regex, units[unit]);
      }
      
      return translated;
    }

    container.innerHTML = `
      <div class="mb-8">
        <h2 class="text-3xl font-extrabold mb-2">${t.title}</h2>
        <p class="text-neutral-400">${t.subtitle}</p>
      </div>

      <div class="mb-8">
        <label class="block text-sm text-neutral-400 mb-2">${t.selectBrand}</label>
        <select id="timelineBrandSelect" class="bg-white/5 border border-white/10 rounded-xl px-4 py-3 w-full max-w-md text-lg">
          <option value="Firemax">Firemax</option>
          <option value="Vikrant">Vikrant</option>
          <option value="Bridgestone">Bridgestone</option>
          <option value="Duraturn">Duraturn</option>
          <option value="Dovroad">Dovroad</option>
          <option value="Kpatos">Kpatos</option>
          <option value="Haida">Haida</option>
          <option value="JK Tyres">JK Tyres</option>
        </select>
      </div>

      <div id="timelineStages" class="timeline-container relative">
        <div class="timeline-line${isRTL ? ' rtl' : ''}"></div>
      </div>
    `;

    function renderTimeline(brandName) {
      const stagesContainer = document.getElementById('timelineStages');
      if (!stagesContainer) return;

      const stages = timelineData[brandName];
      if (!stages) return;

      stagesContainer.innerHTML = `<div class="timeline-line${isRTL ? ' rtl' : ''}"></div>`;

      stages.forEach((stage, index) => {
        setTimeout(() => {
          const stageEl = document.createElement('div');
          stageEl.className = `timeline-stage${isRTL ? ' rtl' : ''}`;
          stageEl.style.animationDelay = `${index * 0.1}s`;

          const dotEl = document.createElement('div');
          dotEl.className = `timeline-dot${isRTL ? ' rtl' : ''}`;

          const contentEl = document.createElement('div');
          contentEl.className = 'glass rounded-2xl p-4 border border-white/10';

          const translatedStage = t.stages[stage.stage] || stage.stage;
          const translatedLocation = translateLocation(stage.location, lang);
          const translatedDuration = translateDuration(stage.duration, lang);

          let html = `<h3 class="text-xl font-bold mb-2">${translatedStage}</h3>`;
          html += `<p class="timeline-location text-emerald-400 text-sm mb-2">${translatedLocation}</p>`;
          if (stage.duration) {
            html += `<span class="timeline-duration inline-block px-3 py-1 rounded-full bg-white/10 text-xs text-neutral-200" style="direction:ltr; unicode-bidi:isolate;">${translatedDuration}</span>`;
          }

          contentEl.innerHTML = html;
          stageEl.appendChild(dotEl);
          stageEl.appendChild(contentEl);
          stagesContainer.appendChild(stageEl);
        }, index * 100);
      });
    }

    const selectEl = document.getElementById('timelineBrandSelect');
    if (selectEl) {
      selectEl.addEventListener('change', function() {
        renderTimeline(this.value);
      });

      renderTimeline('Firemax');
    }
  } catch (err) {
    console.warn('Timeline initialization failed (non-blocking):', err);
  }
}
