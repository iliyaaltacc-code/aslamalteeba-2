<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ุฃุณููุฉ ุงูุทูุจุฉ โ ูุชุฌุฑ ุงูุฅุทุงุฑุงุช</title>
  <meta name="description" content="ุฃุณููุฉ ุงูุทูุจุฉ: ููุฑุฏ ุฅุทุงุฑุงุช ูุชููุฒ ูู ุงูุฅูุงุฑุงุช. ุชุตูุญ Duraturn ู Bridgestone ู Firemax. ุฌูุฏุฉ ูุฅุฑุซ ูุงุนุชูุงุฏูุฉ." />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;600;800&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;600;800&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <script src="../customerMemory.js"></script>
  <style>
    html,body{font-family:Tajawal,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu}
    .glass{backdrop-filter: blur(12px); background: rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1)}
    .brand-gradient{background:linear-gradient(135deg,#00E0A4,#32D5FF)}
    .shine{position:relative;overflow:hidden}
    .shine:after{content:"";position:absolute;inset:-120% auto auto -120%;width:60%;height:300%;transform:rotate(25deg);background:linear-gradient(90deg,transparent,rgba(255,255,255,.18),transparent);animation:shine 6s infinite}
    [x-cloak]{display:none !important}
    @keyframes shine{0%{left:-120%}60%{left:140%}100%{left:140%}}
    
    /* Rank badge and verdict animation */
    @keyframes fadeInScale {
      0% {
        opacity: 0;
        transform: scale(0.8);
      }
      100% {
        opacity: 1;
        transform: scale(1);
      }
    }
    
    /* Slider styling */
    .slider::-webkit-slider-thumb {
      appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: linear-gradient(135deg,#00E0A4,#32D5FF);
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0,224,164,0.4);
    }
    .slider::-moz-range-thumb {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: linear-gradient(135deg,#00E0A4,#32D5FF);
      cursor: pointer;
      border: none;
      box-shadow: 0 2px 8px rgba(0,224,164,0.4);
    }
    
    /* Fix Persian button text shaping */
    a[href="/fa/"] {
      font-family: Vazirmatn, sans-serif !important;
      letter-spacing: 0 !important;
      word-spacing: 0 !important;
      font-variant-ligatures: common-ligatures contextual;
      font-feature-settings: "liga" 1, "clig" 1, "calt" 1, "ccmp" 1;
      text-rendering: optimizeLegibility;
      white-space: nowrap;
      direction: rtl;
    }
    
    /* Fix phone number display for RTL */
    .phone-number {
      direction: ltr;
      unicode-bidi: isolate;
      display: inline-block;
    }
  </style>
</head>
<body class="bg-neutral-950 text-neutral-100" x-data="appState()" x-init="init(); showWelcomeMessage()">
  <!-- HEADER -->
  <header class="sticky top-0 z-50 glass">
    <div class="max-w-7xl mx-auto flex items-center justify-between px-4 py-3">
      <h1 class="text-xl font-extrabold tracking-tight">Aslama <span class="text-emerald-400">Alteeba</span></h1>
      <nav class="hidden md:flex gap-6 text-sm">
        <a href="#about" class="hover:text-white">ูู ูุญู</a>
        <div class="relative" x-data="{open:false}">
          <button class="hover:text-white flex items-center gap-2" aria-haspopup="true" :aria-expanded="open" @click="open = !open" @keydown.escape="open=false">
            ุงูููุชุฌุงุช
            <span class="text-xs text-neutral-400">โพ</span>
          </button>
          <div class="absolute right-0 top-full mt-2 w-72 rounded-2xl border border-white/10 bg-neutral-950/95 backdrop-blur p-2 shadow-xl" x-show="open" x-transition.origin.top.right @click.outside="open=false" x-cloak>
            <a href="#passenger-car-tires" class="block rounded-xl px-3 py-2 text-sm text-neutral-200 hover:bg-white/10" @click="open=false">ุฅุทุงุฑุงุช ุณูุงุฑุงุช ุงูุฑูุงุจ</a>
            <a href="#truck-bus-radial-tires" class="block rounded-xl px-3 py-2 text-sm text-neutral-200 hover:bg-white/10" @click="open=false">ุฅุทุงุฑุงุช ุงูุดุงุญูุงุช ูุงูุญุงููุงุช ุงูุดุนุงุนูุฉ</a>
            <a href="#otr-tires" class="block rounded-xl px-3 py-2 text-sm text-neutral-200 hover:bg-white/10" @click="open=false">ุฅุทุงุฑุงุช OTR</a>
            <a href="#truck-bus-bias-tires" class="block rounded-xl px-3 py-2 text-sm text-neutral-200 hover:bg-white/10" @click="open=false">ุฅุทุงุฑุงุช ุงูุดุงุญูุงุช ูุงูุญุงููุงุช ุจุงูุณ</a>
          </div>
        </div>
        <a href="#hq" class="hover:text-white">ุงูููุฑ ุงูุฑุฆูุณู</a>
        <a href="#imports" class="hover:text-white">ุงูุงุณุชูุฑุงุฏ</a>
        <a href="#shipping" class="hover:text-white">ุงูุดุญู</a>
        <a href="#brands" class="hover:text-white">ุงูุนูุงูุงุช ุงูุชุฌุงุฑูุฉ</a>
        <a href="#intro" class="hover:text-white">ุจุฑูุฏ ุงูุชุนุฑูู</a>
        <a href="#shop" class="hover:text-white">ุงููุชุฌุฑ</a>
        <a href="#contact" class="hover:text-white">ุงุชุตู ุจูุง</a>
      </nav>
      <div class="flex items-center gap-2">
        <button class="px-3 py-2 rounded-xl bg-white/10 border border-white/10" @click="cartOpen=true">
          ุณูุฉ ุงูุดุฑุงุก <span class="ml-1 text-emerald-400 font-bold" x-text="cart.length"></span>
        </button>

        <a href="/" class="px-3 py-2 rounded-xl bg-white/10 border border-white/10 hover:bg-white/15">
          ๐ฌ๐ง English
        </a>
        <a href="/fa/" class="px-3 py-2 rounded-xl bg-white/10 border border-white/10 hover:bg-white/15">
          ๐ฎ๐ท ูุงุฑุณ
        </a>

        <!-- Auth buttons (controlled by Firebase) -->
        <a href="/auth.html" id="authSignInBtn" class="px-3 py-2 rounded-xl bg-white/10 border border-white/10 hover:bg-white/15" style="display: none;">
          ุชุณุฌูู ุงูุฏุฎูู / ุงูุชุณุฌูู
        </a>
        <button id="authSignOutBtn" class="px-3 py-2 rounded-xl bg-white/10 border border-white/10 hover:bg-white/15" style="display: none;">
          ุชุณุฌูู ุงูุฎุฑูุฌ
        </button>

        <a href="tel:+971554637045" class="px-3 py-2 rounded-xl bg-emerald-500 text-black font-semibold hover:opacity-90">
          <span id="phone-display" class="phone-number">+971 55 463 7045</span>
        </a>
      </div>
    </div>
  </header>

  <!-- HERO -->
  <section id="hero" class="max-w-7xl mx-auto px-4 py-12 grid md:grid-cols-2 gap-10 items-center">
    <div>
      <h2 class="text-5xl font-extrabold mb-4 leading-tight">ุฅุทุงุฑุงุช ููุชุงุฒุฉ.<br><span class="text-emerald-400">ุฌูุฏุฉ ุงูุฅูุงุฑุงุช.</span></h2>
      <p class="text-lg text-neutral-300 mb-6">ุชูุฏู ุฃุณููุฉ ุงูุทูุจุฉ ุฅุทุงุฑุงุช ุนุงููุฉ ุงูุฌูุฏุฉ ูู ุฌููุน ุฃูุญุงุก ุงูุฅูุงุฑุงุช. ุดุฑุงูุงุช ูุน Duraturn ู Bridgestone ู Firemax ุชุถูู ุงูุณูุงูุฉ ูุงูุฑุงุญุฉ ูุงูุงุนุชูุงุฏูุฉ.</p>
      <a href="#shop" class="px-6 py-3 rounded-2xl brand-gradient text-black font-bold">ุชุณูู ุงูุฅุทุงุฑุงุช</a>
    </div>
    <div>
      <img src="https://www.duraturntires.com/wp-content/uploads/tire-mozzo-touring-hero.png" class="rounded-2xl shadow-lg" alt="ุนุฑุถ ุฅุทุงุฑุงุช">
    </div>
  </section>

  <!-- ABOUT -->
  <section id="about" class="max-w-7xl mx-auto px-4 py-16">
    <h2 class="text-3xl font-bold mb-4">ุชุงุฑูุฎูุง</h2>
    <p class="text-neutral-300 leading-relaxed">ุชุฃุณุณุช ุฃุณููุฉ ุงูุทูุจุฉ ูู ุฏุจู ุนุงู 2017 ูููุฑุฏ ุตุบูุฑ ูุฑูุฒ ุนูู ุชูููุฑ ุฅุทุงุฑุงุช ุขููุฉุ ุงูุชุตุงุฏูุฉุ ูุฐุงุช ุฃุฏุงุก ููู ููุฃุณูุงู ุงููุญููุฉ. ุนูู ูุฑ ุงูุณููู ุชุทูุฑูุง ุฅูู ููุฒุน ููุซูู ุจูุถู ููุฌุณุชูุงุช ุฏูููุฉ ูุฑุนุงูุฉ ููุชุงุฒุฉ ููุนููุงุก.</p>
  </section>

  <!-- MATERIALS -->
  <section id="materials" class="max-w-7xl mx-auto px-4 py-16 bg-neutral-900/50 rounded-3xl">
    <h2 class="text-3xl font-bold mb-4">ุงูููุชุฌุงุช</h2>
    <p class="text-neutral-300 leading-relaxed mb-8">ุงุณุชูุดู ูุฆุงุช ุงูููุชุฌุงุช ุงูุฃุณุงุณูุฉ ูููุฑูุจุงุช ุงูุฎุงุตุฉุ ุงูุฃุณุงุทูู ุทูููุฉ ุงููุฏูุ ูุงูุงุณุชุฎุฏุงูุงุช ุงูุตูุงุนูุฉ ุงูุซูููุฉ. ูู ูุฆุฉ ูุฎุชุงุฑุฉ ูุชูุฏูู ุฃุฏุงุก ุซุงุจุชุ ุชุขูู ูุชููุนุ ูููุฉ ุจููุฉ ููุซููุฉ ูู ุงูุธุฑูู ุงูุชู ุตููุช ููุง.</p>
    <div class="space-y-32 md:space-y-44">
      <article id="passenger-car-tires" class="glass rounded-3xl p-6 border-white/10 scroll-mt-24">
        <h3 class="text-xl font-bold mb-3">ุฅุทุงุฑุงุช ุณูุงุฑุงุช ุงูุฑูุงุจ</h3>
        <p class="text-neutral-300 leading-relaxed">ุตููุช ุฅุทุงุฑุงุช ุณูุงุฑุงุช ุงูุฑูุงุจ ููุฑุงุญุฉ ุงูููููุฉุ ุงูุถุฌูุฌ ุงูููุฎูุถุ ูุงููุฑููุฉ ุงูุขููุฉ ุนูู ุงูุทุฑู ุงูุณุฑูุนุฉ. ุชุฑููุฒูุง ุนูู ุฃููุงุท ูุฏุงุณ ูุญุณูุฉ ููุชูุงุณู ุนูู ุงูุฃุณุทุญ ุงูุฑุทุจุฉุ ููุงููุฉ ุชุฏุญุฑุฌ ูุชูุงุฒูุฉ ูุงุณุชููุงู ุฃูู ูููููุฏุ ููุชู ูุชู ุซุงุจุชุฉ ูุชุจุฏููุงุช ูุณุงุฑ ูุงุซูุฉ.</p>
        <div class="mt-6 space-y-4">
          <div class="max-w-md">
            <label class="text-sm font-semibold text-neutral-200">ุนูุงูุงุช ุฅุทุงุฑุงุช ุงูุฑูุงุจ</label>
            <select
              x-model="passengerBrandSelection"
              @change="activePassengerBrand = passengerBrandSelection"
              class="mt-2 w-full bg-white/5 border border-white/10 rounded-xl px-3 py-2"
            >
              <option value="">ุงุฎุชุฑ ุนูุงูุฉ ูุนุฑุถ ุงูููุฏููุงุช</option>
              <template x-for="b in passengerBrands" :key="b.name">
                <option :value="b.name" x-text="b.name"></option>
              </template>
            </select>
          </div>

          <div x-show="passengerBrandSelection" x-transition x-cloak class="glass rounded-2xl p-5 border-white/10">
            <div class="flex flex-wrap gap-2 mb-4">
              <template x-for="b in passengerBrands" :key="b.name">
                <button
                  class="px-3 py-2 rounded-xl text-sm border border-white/10"
                  :class="activePassengerBrand === b.name ? 'bg-emerald-400 text-black font-semibold' : 'bg-white/5 text-neutral-200 hover:bg-white/10'"
                  @click="activePassengerBrand = b.name; passengerBrandSelection = b.name"
                  x-text="b.name"
                ></button>
              </template>
            </div>

            <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4" x-show="passengerBrandModels(activePassengerBrand).length">
              <template x-for="m in passengerBrandModels(activePassengerBrand)" :key="m.name">
                <article class="rounded-2xl overflow-hidden bg-black/30 border border-white/10">
                  <img :src="m.img" :alt="m.name" class="w-full h-36 object-cover" />
                  <div class="p-3 space-y-1">
                    <h4 class="font-semibold" x-text="m.name"></h4>
                    <p class="text-xs text-neutral-400" x-text="m.desc"></p>
                  </div>
                </article>
              </template>
            </div>
            <p class="text-sm text-neutral-400" x-show="passengerBrandSelection && !passengerBrandModels(activePassengerBrand).length">
              ุณูุชู ุฅุถุงูุฉ ุงูููุฏููุงุช ูุฑูุจุงู.
            </p>
          </div>
        </div>
      </article>
      <article id="truck-bus-radial-tires" class="glass rounded-3xl p-6 border-white/10 scroll-mt-24">
        <h3 class="text-xl font-bold mb-3">ุฅุทุงุฑุงุช ุงูุดุงุญูุงุช ูุงูุญุงููุงุช ุงูุดุนุงุนูุฉ</h3>
        <p class="text-neutral-300 leading-relaxed">ุจููุช ุฅุทุงุฑุงุช ุงูุดุงุญูุงุช ูุงูุญุงููุงุช ุงูุดุนุงุนูุฉ ูุชุนุธูู ุงููุณุงูุฉ ุงูููุทูุนุฉ ูุงุณุชูุฑุงุฑ ุงูุญูููุฉ ููุฃุณุงุทูู ุงูุชุฌุงุฑูุฉ. ุงูุจูุงุก ุงูุดุนุงุนู ุงููุฏุนู ุจุงููููุงุฐ ูููู ุงูุญุฑุงุฑุฉ ููุญุณู ุนูุฑ ุงููุฏุงุณ ููุชูุญ ุฏูุฑุงุช ุฅุนุงุฏุฉ ุงูููุดุ ูุง ูุฎูุถ ุงูุชูููุฉ ููู ูููููุชุฑ.</p>
      </article>
      <article id="otr-tires" class="glass rounded-3xl p-6 border-white/10 scroll-mt-24">
        <h3 class="text-xl font-bold mb-3">ุฅุทุงุฑุงุช OTR</h3>
        <p class="text-neutral-300 leading-relaxed">ุฅุทุงุฑุงุช OTR (ููุนูู ุฎุงุฑุฌ ุงูุทุฑู) ูุฎุตุตุฉ ููุขููุงุช ุงูุซูููุฉ ูู ุงููุญุงุฌุฑ ูููุงูุน ุงูุจูุงุก ูุงูุชุนุฏูู. ุชุนุทู ุฃููููุฉ ูููุงููุฉ ุงููุทุน ูุนูู ุงููุฏุงุณ ุงูุนุงูู ูุญูุงูุฉ ุงูุฌุฏุงุฑ ุงูุฌุงูุจูุ ูุถูุงู ุนูุฑ ุฎุฏูุฉ ุทููู ูู ุงูุจูุฆุงุช ุงููุงุณูุฉ.</p>
      </article>
      <article id="truck-bus-bias-tires" class="glass rounded-3xl p-6 border-white/10 scroll-mt-24">
        <h3 class="text-xl font-bold mb-3">ุฅุทุงุฑุงุช ุงูุดุงุญูุงุช ูุงูุญุงููุงุช ุจุงูุณ</h3>
        <p class="text-neutral-300 leading-relaxed">ูุง ุชุฒุงู ุฅุทุงุฑุงุช ุงูุจุงูุณ ุฎูุงุฑุงู ููุงุณุจุงู ููุณุงุฑุงุช ุงูููุงุทู ูุงูุฃุณุทุญ ุงููุชููุนุฉ ูุงูุญูููุงุช ุงูุซูููุฉ ุจุณุฑุนุงุช ููุฎูุถุฉ. ุจููุชูุง ุงููุชูุงุทุนุฉ ุชุนุฒุฒ ุตูุงุจุฉ ุงูุฌุฏุงุฑ ุงูุฌุงูุจู ูููุงููุฉ ุงูุตุฏูุงุชุ ูุง ูุฌุนููุง ููุงุณุจุฉ ููุทุฑู ุงููุนุฑุฉ ูุงูุฃุณุงุทูู ุงููุฏููุฉ.</p>
      </article>
    </div>
  </section>

  <!-- HQ -->
  <section id="hq" class="max-w-7xl mx-auto px-4 py-16">
    <h2 class="text-3xl font-bold mb-4">ุงูููุฑ ุงูุฑุฆูุณู ูุงููุฑุงูู</h2>
    <p class="text-neutral-300 leading-relaxed">ููุน ููุฑูุง ุงูุฑุฆูุณู ูู ุฏุจู ููุฑูุฒ ุนูููุงุช ุงูููุฌุณุชูุงุช ูุงูุชูุณูู ูุน ุงูุดุญูุงุช ูุงูุดุฑูุงุก. ูุน ูุฑุงูู ูู ุงูุดุงุฑูุฉ ูุฑุฃุณ ุงูุฎููุฉุ ูุถูู ุชูุฒูุนุงู ุณุฑูุนุงู ูุชุชุจุนุงู ูุญุธูุงู ูููุฎุฒูู.</p>
  </section>

  <!-- IMPORTS -->
  <section id="imports" class="max-w-7xl mx-auto px-4 py-16 bg-neutral-900/50 rounded-3xl">
    <h2 class="text-3xl font-bold mb-4">ุงูุงุณุชูุฑุงุฏ ุงูุนุงููู</h2>
    <p class="text-neutral-300 leading-relaxed">ูุณุชูุฑุฏ ูู ูุตุงูุน ูุนุชูุฏุฉ ูู ุงููุงุจุงู ูุงูุตูู ูุชุงููุงูุฏุ ูุน ุนูุงูุงุช ูุจุงุดุฑุฉ ูุน Duraturn ู Bridgestone ู Firemax. ูู ุดุญูุฉ ุชูุฑ ุจุฅุฌุฑุงุกุงุช ูุญุต ูุถูุงู ุงูุฃุตุงูุฉ ูุงูุชุชุจุน.</p>
  </section>

  <!-- SHIPPING -->
  <section id="shipping" class="max-w-7xl mx-auto px-4 py-16">
    <h2 class="text-3xl font-bold mb-4">ุงูุดุญู ูุงูุชุฑููุจ</h2>
    <p class="text-neutral-300 leading-relaxed">ุชูุตูู ุณุฑูุน ุฅูู ุฌููุน ุฅูุงุฑุงุช ุงูุฏููุฉ. ูููู ุงุฎุชูุงุฑ ุงูุงุณุชูุงู ูู ุงููููุนุ ุงูุชุฑููุจ ูู ุงููููุนุ ุฃู ุงูุดุญู ุงููุจุงุดุฑ ูุนููุงุก ุงูุฃุณุงุทูู. ูุชุนุงูู ูุน ูุฑุงูุฒ ุงูุฎุฏูุฉ ูุชูููุฑ ุชุฑููุจ ูู ุงูููู ููุณู ุนูุฏ ุงูุฅููุงู.</p>
  </section>

  <!-- BRANDS -->
  <section id="brands" class="max-w-7xl mx-auto px-4 py-20 bg-neutral-900/40 rounded-3xl">
    <div class="flex items-end justify-between gap-4 mb-8">
      <div>
        <h2 class="text-3xl font-extrabold">ุงูุนูุงูุงุช ุงูุชุฌุงุฑูุฉ</h2>
        <p class="text-neutral-400">ุชุตูุญ ุนูุงูุงุชูุง ุงูุดุฑููุฉ ูุฃุฑุณู ุงุณุชูุณุงุฑุงู ููุฑุงู.</p>
      </div>
    </div>

    <div class="grid sm:grid-cols-2 lg:grid-cols-4 gap-5">
      <template x-for="b in brands" :key="b.name">
        <article class="glass rounded-3xl overflow-hidden border-white/10">
          <div class="bg-black/30 p-4 h-32 flex items-center justify-center">
            <img :src="b.img" :alt="b.name + ' logo'" class="max-h-24 object-contain" />
          </div>
          <div class="p-4 space-y-3">
            <div class="flex items-center justify-between gap-2">
              <h3 class="font-bold text-lg" x-text="b.name"></h3>
              <span class="text-xs px-2 py-1 rounded-full bg-white/10" x-text="brandProductCount(b.name) + ' ููุชุฌุงุช'"></span>
            </div>
            <p class="text-neutral-300 text-sm" x-text="b.desc"></p>
            <button class="w-full px-4 py-2 rounded-xl brand-gradient text-black font-bold hover:opacity-90" @click="sendBrandInquiry(b.name)">
              ุฅุฑุณุงู ุงุณุชูุณุงุฑ
            </button>
          </div>
        </article>
      </template>
    </div>
  </section>

  <!-- INTRODUCTION EMAIL -->
  <section id="intro" class="max-w-7xl mx-auto px-4 py-16 bg-neutral-900/40 rounded-3xl">
    <h2 class="text-3xl font-bold mb-4">ุงูุญุตูู ุนูู ุจุฑูุฏ ุชุนุฑููู</h2>
    <p class="text-neutral-300 mb-6">ุฃุฏุฎู ุจูุงูุงุชู ููุญุตูู ุนูู ุจุฑูุฏ ุชุนุฑููู ูููู ุนู ุฎุฏูุงุชูุง. ุณูุชู ุฅุฑุณุงู ูุณุฎุฉ ูู ููุณุฎุฉ ุฅูู ุจุฑูุฏูุง.</p>
    <form @submit.prevent="sendIntro" class="space-y-4 max-w-xl">
      <input required x-model="intro.name" class="bg-white/5 border border-white/10 rounded-xl px-3 py-2 w-full" placeholder="ุงูุงุณู ุงููุงูู"/>
      <input required x-model="intro.email" type="email" class="bg-white/5 border border-white/10 rounded-xl px-3 py-2 w-full" placeholder="ุงูุจุฑูุฏ ุงูุฅููุชุฑููู"/>
      <input required x-model="intro.phone" class="bg-white/5 border border-white/10 rounded-xl px-3 py-2 w-full" placeholder="ุฑูู ุงููุงุชู"/>
      <button class="px-6 py-3 rounded-2xl brand-gradient text-black font-bold">ุฅุฑุณุงู ุงูุจุฑูุฏ ุงูุชุนุฑููู</button>
      <p x-show="introSuccess" class="text-emerald-400 text-sm mt-1">โ ุชู ุฅุฑุณุงู ุงูุจุฑูุฏ ุจูุฌุงุญ!</p>
      <p x-show="introError" class="text-red-400 text-sm mt-1" x-text="introError"></p>
    </form>
  </section>

  <!-- SHOP -->
  <section id="shop" class="max-w-7xl mx-auto px-4 py-20">
    <div class="flex items-end justify-between gap-4 mb-6">
      <div>
        <h2 class="text-3xl font-extrabold">ูุชุฌุฑ ุงูุฅุทุงุฑุงุช</h2>
        <p class="text-neutral-400">ุงุจุญุซุ ุตูู ุญุณุจ ุงูุนูุงูุฉุ ุฃุถู ุฅูู ุงูุณูุฉุ ูุฃุฑุณู ุทูุจุงู ุชุฌุฑูุจูุงู.</p>
        <p class="text-amber-400 text-sm mt-1" x-show="bulkMode" x-cloak>ูุทูุจุงุช ุงูุฌููุฉ ูุงูุงุณุชูุณุงุฑุงุช ุนู ุฃุณุนุงุฑ ุงูุฌููุฉ</p>
      </div>
      <div class="flex gap-2 items-center">
        <label class="flex items-center gap-2 text-sm cursor-pointer">
          <input type="checkbox" x-model="bulkMode" @change="toggleBulkMode()" class="rounded">
          <span>ุงูุทูุจุงุช ุจุงูุฌููุฉ</span>
        </label>
        <select x-model="selectedCurrency" class="bg-white/5 border border-white/10 rounded-xl px-3 py-2">
          <option value="USD">ุฏููุงุฑ ุฃูุฑููู ($)</option>
          <option value="AED">ุฏุฑูู ุฅูุงุฑุงุชู (ุฏ.ุฅ)</option>
        </select>
        <select x-model="filters.brand" class="bg-white/5 border border-white/10 rounded-xl px-3 py-2">
          <option value="">ูู ุงูุนูุงูุงุช</option>
          <option>Duraturn</option>
          <option>Bridgestone</option>
          <option>Firemax</option>
        </select>
        <input x-model="filters.query" type="search" placeholder="ุงุจุญุซ ุนู ุงูููุงุณโฆ ูุซู 205/55R16" class="bg-white/5 border border-white/10 rounded-xl px-3 py-2 placeholder:text-neutral-500" />
      </div>
    </div>

    <!-- Interactive Tire Universe -->
    <div 
      id="tire-universe-sliders"
      class="mb-12 glass rounded-3xl p-8 border-white/10 transition-all duration-700"
      :class="slidersDocked ? 'slider-docked' : ''"
      :style="slidersDocked ? 'position: fixed; top: 120px; left: 20px; width: 320px; z-index: 50; box-shadow: 0 20px 50px rgba(0,0,0,0.5);' : ''"
    >
      <div class="flex items-center justify-between mb-4">
        <div>
          <h3 class="text-2xl font-bold">ุนุงูู ุงูุฅุทุงุฑุงุช ุงูุชูุงุนูู</h3>
          <p class="text-neutral-400 text-sm">ุงุณุชูุดู ุงูุฅุทุงุฑุงุช ุจุตุฑูุงู โ ุงุถุจุท ุงูุฃุฒุฑุงุฑ ููุดุงูุฏุฉ ุชูุงุนู ุงูููุชุฌุงุช</p>
        </div>
        <button 
          @click="toggleSlidersDocked()"
          class="mr-4 px-3 py-2 rounded-lg bg-white/5 hover:bg-white/10 border border-white/10 hover:border-white/20 transition-all text-sm font-semibold whitespace-nowrap"
          :title="slidersDocked ? 'ุฅูุบุงุก ุงูุชุซุจูุช' : 'ุชุซุจูุช ุนูุงุตุฑ ุงูุชุญูู'"
        >
          <span x-text="slidersDocked ? 'ุฅูุบุงุก ุงูุชุซุจูุช' : 'ุชุซุจูุช ุนูุงุตุฑ ุงูุชุญูู'"></span>
        </button>
      </div>
      
      <div class="max-w-3xl space-y-6" :class="slidersDocked ? '' : 'mx-auto'">
        <!-- Slider 1: Highway <-> City (reversed for RTL) -->
        <div>
          <div class="flex justify-between items-center mb-2">
            <label class="text-sm font-semibold text-neutral-300">ุทุฑูู ุณุฑูุน</label>
            <label class="text-sm font-semibold text-neutral-300">ูุฏููุฉ</label>
          </div>
          <input 
            type="range" 
            min="0" 
            max="100" 
            x-model.number="tireUniverse.drivingType"
            @input.debounce.150ms="updateTireScores()"
            class="w-full h-2 bg-white/10 rounded-lg appearance-none cursor-pointer slider"
          />
        </div>

        <!-- Slider 2: Performance <-> Budget (reversed for RTL) -->
        <div>
          <div class="flex justify-between items-center mb-2">
            <label class="text-sm font-semibold text-neutral-300">ุฃุฏุงุก</label>
            <label class="text-sm font-semibold text-neutral-300">ููุฒุงููุฉ</label>
          </div>
          <input 
            type="range" 
            min="0" 
            max="100" 
            x-model.number="tireUniverse.priority"
            @input.debounce.150ms="updateTireScores()"
            class="w-full h-2 bg-white/10 rounded-lg appearance-none cursor-pointer slider"
          />
        </div>

        <!-- Slider 3: Aggressive <-> Quiet (reversed for RTL) -->
        <div>
          <div class="flex justify-between items-center mb-2">
            <label class="text-sm font-semibold text-neutral-300">ุฑูุงุถู</label>
            <label class="text-sm font-semibold text-neutral-300">ูุงุฏุฆ</label>
          </div>
          <input 
            type="range" 
            min="0" 
            max="100" 
            x-model.number="tireUniverse.drivingStyle"
            @input.debounce.150ms="updateTireScores()"
            class="w-full h-2 bg-white/10 rounded-lg appearance-none cursor-pointer slider"
          />
        </div>
      </div>
    </div>

    <!-- PODIUM STAGE (separate from product grid) -->
    <div class="mb-12 relative" style="height: 650px;">
      <div class="absolute inset-0 glass rounded-3xl border-white/10 overflow-hidden">
        <h3 class="text-xl font-bold text-center pt-4 pb-2">ุชุฑุชูุจ ุงูุจูุฏููู</h3>
        
        <!-- 6 Fixed Podium Slots -->
        <div class="relative w-full h-full">
          <template x-for="p in products" :key="p.id">
            <div 
              :id="'podium-' + p.id"
              class="absolute podium-card glass rounded-2xl overflow-hidden border-white/10"
              :style="getPodiumSlotStyle(p)"
              style="width: 200px; transition: all 1.4s cubic-bezier(0.22, 1, 0.36, 1);"
            >
              <!-- Rank Badge (RTL: top-left) -->
              <div 
                class="absolute top-2 left-2 w-12 h-12 rounded-full flex flex-col items-center justify-center font-bold text-white shadow-lg z-10"
                :style="{ background: getRankBadge(p).bg }"
              >
                <div class="text-xl" x-text="getRankBadge(p).medal"></div>
                <div class="text-xs" x-text="getRankBadge(p).text"></div>
              </div>
              
              <img :src="p.img" :alt="p.name" class="w-full h-32 object-contain bg-black/20"/>
              <div class="p-3">
                <h4 class="font-bold text-sm mb-1" x-text="p.name"></h4>
                <div 
                  class="text-xs font-semibold mb-1"
                  :style="{ color: getVerdictTextAr(p).color }"
                  x-text="getVerdictTextAr(p).text"
                ></div>
                <p class="text-neutral-400 text-xs" x-text="p.size"></p>
              </div>
            </div>
          </template>
        </div>
      </div>
    </div>

    <!-- Original Product Grid (unchanged) -->
    <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-5">
      <template x-for="p in filteredProducts()" :key="p.id">
        <article 
          class="glass rounded-3xl overflow-hidden shine border-white/10"
        >
          <img :src="p.img" :alt="p.name" class="w-full h-48 object-contain bg-black/30"/>
          <div class="p-4 space-y-2">
            <div class="flex items-center justify-between gap-2">
              <h3 class="font-bold" x-text="p.name"></h3>
              <span class="text-xs px-2 py-1 rounded-full bg-white/10" x-text="p.brand"></span>
            </div>
            
            <!-- Verdict Text (under product name) -->
            <div 
              class="text-sm font-semibold text-right"
              :style="{ color: getVerdictTextAr(p).color }"
              x-text="getVerdictTextAr(p).text"
              style="animation: fadeInScale 0.4s ease-out 0.15s both;"
            ></div>
            
            <p class="text-neutral-300 text-sm" x-text="p.desc"></p>
            
            <!-- Quick Questions Section (Arabic) -->
            <div class="pt-2 border-t border-white/10">
              <div class="flex items-center justify-between mb-2">
                <span class="text-xs font-semibold text-neutral-400">ุฃุณุฆูุฉ ุณุฑูุนุฉ</span>
                <button 
                  @click="refreshProductQuestions(p)" 
                  class="text-xs px-2 py-1 rounded-lg bg-white/5 hover:bg-white/10 text-neutral-300"
                  title="ุชุญุฏูุซ ุงูุฃุณุฆูุฉ">
                  โป
                </button>
              </div>
              <div class="space-y-1">
                <template x-for="(q, idx) in getProductQuestions(p)" :key="p.id + '-' + idx">
                  <button 
                    @click="openChatWithQuestion(q, p)"
                    class="w-full text-right text-xs px-2 py-1.5 rounded-lg bg-white/5 hover:bg-teal-500/20 text-neutral-300 hover:text-teal-300 transition-colors"
                    x-text="q">
                  </button>
                </template>
              </div>
            </div>
            
            <div class="flex items-center justify-between pt-2">
              <!-- Normal mode -->
              <template x-if="!bulkMode">
                <div class="flex items-center justify-between w-full">
                  <div>
                    <div class="text-lg font-extrabold" x-text="formatPrice(p.price)"></div>
                    <div class="text-xs text-neutral-400" x-text="p.size"></div>
                  </div>
                  <button class="px-4 py-2 rounded-xl brand-gradient text-black font-bold hover:opacity-90" @click="addToCart(p)">ุฅุถุงูุฉ</button>
                </div>
              </template>
              
              <!-- Bulk mode -->
              <template x-if="bulkMode">
                <div class="flex flex-col gap-2 w-full">
                  <div class="flex items-center justify-between">
                    <div>
                      <div class="text-sm text-neutral-400">ุงุชุตู ุจูุง ููุญุตูู ุนูู ุฃุณุนุงุฑ ุงูุฌููุฉ</div>
                      <div class="text-xs text-neutral-400" x-text="p.size"></div>
                    </div>
                  </div>
                  <button class="w-full px-4 py-2 rounded-xl bg-amber-500 text-black font-bold hover:opacity-90" @click="requestBulkQuote(p)">ุทูุจ ุนุฑุถ ุณุนุฑ ุจุงูุฌููุฉ</button>
                </div>
              </template>
            </div>
          </div>
        </article>
      </template>
    </div>
  </section>

  <!-- CONTACT -->
  <section id="contact" class="max-w-7xl mx-auto px-4 py-20">
    <h2 class="text-3xl font-bold mb-6">ุงุชุตู ุจูุง</h2>
    <form @submit.prevent="sendContact" class="space-y-4 max-w-xl">
      <input required x-model="contact.name" class="bg-white/5 border border-white/10 rounded-xl px-3 py-2 w-full" placeholder="ุงุณูู"/>
      <input required x-model="contact.email" type="email" class="bg-white/5 border border-white/10 rounded-xl px-3 py-2 w-full" placeholder="ุจุฑูุฏู ุงูุฅููุชุฑููู"/>
      <textarea required x-model="contact.message" rows="4" class="bg-white/5 border border-white/10 rounded-xl px-3 py-2 w-full" placeholder="ุฑุณุงูุชู"></textarea>
      <button class="px-6 py-3 rounded-2xl brand-gradient text-black font-bold">ุฅุฑุณุงู ุงูุฑุณุงูุฉ</button>
    </form>
  </section>

  <!-- FOOTER -->
  <footer class="border-t border-white/10 text-neutral-400 text-sm text-center py-6">
    ยฉ <span x-text="new Date().getFullYear()"></span> Aslama Alteeba. ุฌููุน ุงูุญููู ูุญููุธุฉ.
  </footer>

  <!-- CART DRAWER -->
  <div class="fixed inset-0 z-50" x-show="cartOpen" x-transition>
    <div class="absolute inset-0 bg-black/60" @click="cartOpen=false"></div>
    <aside class="absolute left-0 top-0 bottom-0 w-full max-w-md bg-neutral-900 border-r border-white/10 p-5 overflow-y-auto">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-extrabold">ุณูุฉ ุงูุดุฑุงุก ุงูุฎุงุตุฉ ุจู</h3>
        <button class="p-2 rounded-lg bg-white/5" @click="cartOpen=false">โ</button>
      </div>

      <template x-if="cart.length===0">
        <p class="text-neutral-400">ุงูุณูุฉ ูุงุฑุบุฉ.</p>
      </template>

      <div class="space-y-3">
        <template x-for="(item, idx) in cart" :key="item.id + '-' + idx">
          <div class="flex gap-3 items-center glass rounded-2xl p-3">
            <img :src="item.img" :alt="item.name" class="w-16 h-16 rounded-xl object-contain bg-black/30"/>
            <div class="flex-1">
              <div class="font-semibold" x-text="item.name"></div>
              <div class="text-xs text-neutral-400" x-text="item.size + ' โข ' + item.brand"></div>
              <div class="text-sm" x-text="formatPrice(item.price)"></div>
            </div>
            <div class="flex items-center gap-2">
              <button class="px-2 py-1 bg-white/10 rounded" @click="item.qty = Math.max(1, item.qty-1)">-</button>
              <span x-text="item.qty"></span>
              <button class="px-2 py-1 bg-white/10 rounded" @click="item.qty++">+</button>
              <button class="px-2 py-1 bg-white/10 rounded" title="ุฅุฒุงูุฉ" @click="cart.splice(idx,1)">ร</button>
            </div>
          </div>
        </template>
      </div>

      <div class="mt-6 p-4 glass rounded-2xl space-y-2">
        <div class="flex items-center justify-between text-sm">
          <span>ุงูุฅุฌูุงูู ุงููุฑุนู</span>
          <span x-text="formatPrice(subtotal())"></span>
        </div>
        <div class="flex items-center justify-between text-sm text-neutral-400">
          <span>ุงูุถุฑูุจุฉ (5% ุชุฌุฑูุจูุฉ)</span>
          <span x-text="formatPrice(subtotal()*0.05)"></span>
        </div>
        <div class="flex items-center justify-between font-bold pt-1">
          <span>ุงูุฅุฌูุงูู</span>
          <span x-text="formatPrice(subtotal()*1.05)"></span>
        </div>
      </div>

      <form class="mt-6 space-y-3" @submit.prevent="placeOrder()">
        <h4 class="font-bold">ุฅุชูุงู ุงูุดุฑุงุก</h4>
        <input required x-model="checkout.name" class="bg-white/5 border border-white/10 rounded-xl px-3 py-2 w-full" placeholder="ุงูุงุณู ุงููุงูู"/>
        <input required x-model="checkout.email" type="email" class="bg-white/5 border border-white/10 rounded-xl px-3 py-2 w-full" placeholder="ุงูุจุฑูุฏ ุงูุฅููุชุฑููู ููุชุฃููุฏ"/>
        <input x-model="checkout.phone" class="bg-white/5 border border-white/10 rounded-xl px-3 py-2 w-full" placeholder="ุฑูู ุงููุงุชู (ุงุฎุชูุงุฑู)"/>
        <input x-model="checkout.vehicle" class="bg-white/5 border border-white/10 rounded-xl px-3 py-2 w-full" placeholder="ุงููุฑูุจุฉ (ุงุฎุชูุงุฑู)"/>
        <button class="w-full px-5 py-3 rounded-2xl brand-gradient text-black font-bold" :disabled="cart.length===0">ุฅุฑุณุงู ุทูุจ ุชุฌุฑูุจู</button>
        <p class="text-xs text-neutral-400">ุณูุชู ุฅุฑุณุงู ุจุฑูุฏูู: ูุงุญุฏ ููุง ููุงุญุฏ ูู. ูุง ุญุงุฌุฉ ูุชุทุจูู ุงูุจุฑูุฏ.</p>
      </form>
    </aside>
  </div>

  

      <div class="max-h-80 overflow-y-auto px-4 py-3 space-y-3" x-ref="chatScroll">
        <template x-for="(msg, idx) in chatMessages" :key="idx">
          <div class="flex" :class="msg.role === 'user' ? 'justify-end' : 'justify-start'">
            <div
              class="px-3 py-2 rounded-2xl text-sm max-w-[80%]"
              :class="msg.role === 'user' ? 'bg-emerald-500 text-black' : 'bg-white/10 text-neutral-100'"
              x-text="msg.content"
            ></div>
          </div>
        </template>

        <template x-if="chatLoading">
          <div class="flex justify-start">
            <div class="px-3 py-2 rounded-2xl text-sm bg-white/10 text-neutral-100">ููุชุจโฆ</div>
          </div>
        </template>
      </div>

      <div class="border-t border-white/10 px-3 py-3 space-y-2">
        <p class="text-xs text-red-400" x-show="chatError" x-text="chatError"></p>
        <form class="flex gap-2" @submit.prevent="sendChatMessage()">
          <input
            x-model="chatInput"
            class="flex-1 bg-white/5 border border-white/10 rounded-xl px-3 py-2 text-sm text-right"
            placeholder="ุงูุชุจ ุณุคุงูู..."
            :disabled="chatLoading"
          />
          <button
            class="px-4 py-2 rounded-xl brand-gradient text-black font-bold"
            :disabled="chatLoading || !chatInput.trim()"
          >
            ุฅุฑุณุงู
          </button>
        </form>
      </div>
    </div>
  </div>

  <!-- WHATSAPP FLOAT BUTTON (ALWAYS VISIBLE) -->
  <a
    href="https://wa.me/971554637045?text=Hello%20Aslama%20Alteeba%2C%20I%20would%20like%20to%20inquire%20about%20tires."
    class="fixed bottom-5 right-5 z-50 px-4 py-3 rounded-2xl bg-emerald-500 text-black font-extrabold shadow-lg hover:opacity-90"
    aria-label="WhatsApp"
    target="_blank"
    rel="noopener"
    @click="trackWhatsAppUsage()"
  >
    ูุงุชุณุงุจ
  </a>

  <!-- SCRIPTS -->
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
  <script>
    const EMAILJS_PUBLIC_KEY = "qkXfa4_PMbGhuWHaX";
    const EMAILJS_SERVICE_ID = "service_hhs4z1i";
    const EMAILJS_TEMPLATE_ID = "template_2djz9zc";   // orders + contact + brand inquiries
    const EMAILJS_INTRO_TEMPLATE = "template_efwbezh"; // introduction email

    if (EMAILJS_PUBLIC_KEY) emailjs.init({ publicKey: EMAILJS_PUBLIC_KEY });

    function appState(){
      // Restore preferences directly from localStorage before Alpine initializes
      // Reading directly ensures values are available synchronously
      let initialCurrency = 'USD';
      let initialBulkMode = false;
      let initialSlidersDocked = false;
      let initialBrandFilter = '';
      
      try {
        // Read directly from localStorage (synchronous, guaranteed to work)
        const savedCurrency = localStorage.getItem('aa_currency');
        if (savedCurrency && ['USD', 'AED'].includes(savedCurrency)) {
          initialCurrency = savedCurrency;
        }
        
        const savedBulkMode = localStorage.getItem('aa_bulkMode');
        if (savedBulkMode === 'true') {
          initialBulkMode = true;
        }
        
        const savedSlidersDocked = localStorage.getItem('aa_slidersDocked');
        if (savedSlidersDocked === 'true') {
          initialSlidersDocked = true;
        }
        
        const savedBrandFilter = localStorage.getItem('aa_brandFilter');
        if (savedBrandFilter) {
          initialBrandFilter = savedBrandFilter;
        }
      } catch (e) {
        // localStorage not available, use defaults
        console.warn('localStorage not available:', e);
      }
      
      return {
        cartOpen:false,
        filters:{brand: initialBrandFilter, query:''},
        passengerBrandSelection:'',
        activePassengerBrand:'',
        contact:{name:'',email:'',message:''},
        checkout:{name:'',email:'',phone:'',vehicle:''},
        intro:{name:'',email:'',phone:''},
        introSuccess:false,
        introError:'',
        chatOpen:false,
        chatInput:'',
        chatLoading:false,
        chatError:'',
        chatMessages:[
          {role:'assistant', content:'ูุฑุญุจุงู ุจู ูู Aslama Alteeba. ููู ูููููุง ุงููุณุงุนุฏุฉ ูู ุงูุฅุทุงุฑุงุช ุฃู ุงูููุงุณุงุช ุฃู ุงูุชููุฑุ'}
        ],
        
        // Currency conversion
        selectedCurrency: initialCurrency,
        exchangeRates: { USD: 1, AED: 3.67 },
        currencySymbols: { USD: '$', AED: 'ุฏ.ุฅ' },

        // Bulk Mode
        bulkMode: initialBulkMode,

        // Sliders Docked Mode
        slidersDocked: initialSlidersDocked,

        // Interactive Tire Universe
        tireUniverse: {
          drivingType: 50,  // 0 = City, 100 = Highway
          priority: 50,     // 0 = Budget, 100 = Performance
          drivingStyle: 50, // 0 = Quiet, 100 = Aggressive
          scores: {},       // product scores cache
          ranks: {}         // product ranks (1-6)
        },
        
        toggleSlidersDocked(){
          this.slidersDocked = !this.slidersDocked;
          // Persist state
          if (window.CustomerMemory) {
            CustomerMemory.setSlidersDocked(this.slidersDocked);
          }
        },

        toggleBulkMode(){
          // Bulk mode is now automatically saved via watcher in init()
          // This method just toggles the value, the watcher handles persistence
        },

        requestBulkQuote(p){
          const text = `ูุฑุญุจุงูุ ุฃุทูุจ ุนุฑุถ ุฃุณุนุงุฑ ุจุงูุฌููุฉ ูู:\n\n- ุงูููุชุฌ: ${p.name}\n- ุงูููุงุณ: ${p.size}\n- ุงูุนูุงูุฉ: ${p.brand}\n\nุงููููุฉ: `;
          window.open('https://wa.me/971554637045?text=' + encodeURIComponent(text), '_blank');
          // Track bulk quote usage
          if (window.CustomerMemory) {
            CustomerMemory.markBulkQuoteUsed();
          }
        },

        brands:[
          {name:'Firemax', img:'https://i.postimg.cc/nrLrwP86/firemax-logo-e-motors-ru-removebg-preview.png', desc:'ุชุดูููุฉ ุงูุชุตุงุฏูุฉ ูุณูุงุฑุงุช ุงูุฑูุงุจ ูSUV.'},
          {name:'Duraturn', img:'https://i.postimg.cc/ZKGYrRq1/4h-HO1KRF0AYc-JDu3S1nl0w3a0n-OYIt-SV0vrue-CTf-png.webp', desc:'ุฌูุฏุฉ ุงูุชุตุงุฏูุฉ ูุน ุฎูุงุฑุงุช ุชูุฑููุบ ูA/T ูููุฉ.'},
          {name:'Haida', img:'https://i.postimg.cc/yNYNNGxd/haidatireb.webp', desc:'ูุฌููุนุฉ ููุซููุฉ ุชุฌูุน ุจูู ุงููุชุงูุฉ ูุงููููุฉ.'},
          {name:'Vikrant', img:'https://i.postimg.cc/vZXQCvzS/Vikrant-Tyres-Logo.jpg', desc:'ุฅุทุงุฑุงุช ูุฃุฏุงุก ุซุงุจุช ูุงุณุชุฎุฏุงู ูููู.'}
        ],

        passengerBrands:[
          {
            name:'Firemax',
            models:[
              {name:'FM601', img:'https://placehold.co/600x400?text=Firemax+FM601', desc:'ุตูุฑุฉ ูุคูุชุฉ ุญุชู ุชูููุฑ ุงูุตูุฑุฉ ุงูุฑุณููุฉ.'},
              {name:'FM518', img:'https://placehold.co/600x400?text=Firemax+FM518', desc:'ุตูุฑุฉ ูุคูุชุฉ ุญุชู ุชูููุฑ ุงูุตูุฑุฉ ุงูุฑุณููุฉ.'},
              {name:'POTENTIA SPORT 2', img:'https://placehold.co/600x400?text=POTENTIA+SPORT+2', desc:'ุตูุฑุฉ ูุคูุชุฉ ุญุชู ุชูููุฑ ุงูุตูุฑุฉ ุงูุฑุณููุฉ.'}
            ]
          },
          {
            name:'Kpatos',
            models:[
              {name:'ูุฑูุจุงู', img:'https://placehold.co/600x400?text=Coming+Soon', desc:'ุณูุชู ุฅุถุงูุฉ ุงูููุฏููุงุช ูุฑูุจุงู.'}
            ]
          },
          {
            name:'Dovroad',
            models:[
              {name:'ูุฑูุจุงู', img:'https://placehold.co/600x400?text=Coming+Soon', desc:'ุณูุชู ุฅุถุงูุฉ ุงูููุฏููุงุช ูุฑูุจุงู.'}
            ]
          },
          {
            name:'Haida',
            models:[
              {name:'ูุฑูุจุงู', img:'https://placehold.co/600x400?text=Coming+Soon', desc:'ุณูุชู ุฅุถุงูุฉ ุงูููุฏููุงุช ูุฑูุจุงู.'}
            ]
          },
          {
            name:'Neolin',
            models:[
              {name:'ูุฑูุจุงู', img:'https://placehold.co/600x400?text=Coming+Soon', desc:'ุณูุชู ุฅุถุงูุฉ ุงูููุฏููุงุช ูุฑูุจุงู.'}
            ]
          },
          {
            name:'Duraturn',
            models:[
              {name:'ูุฑูุจุงู', img:'https://placehold.co/600x400?text=Coming+Soon', desc:'ุณูุชู ุฅุถุงูุฉ ุงูููุฏููุงุช ูุฑูุจุงู.'}
            ]
          }
        ],

        products:[
          {id:'dur-1', brand:'Duraturn', name:'Duraturn Mozzo Touring', size:'205/55R16', price:79.99, img:'https://www.duraturntires.com/wp-content/uploads/tire-mozzo-touring-hero.png', desc:'ุฑุงุญุฉ ุทูุงู ุงูููุงุณู ูุน ูุฏุงุณ ูุญุณู.'},
          {id:'bri-1', brand:'Bridgestone', name:'Bridgestone WeatherPeak', size:'225/45R17', price:129.99, img:'https://cdn.pneusecono.ca/images/produits/Bridgestone-Weatherpeak.jpg', desc:'ุซูุฉ ูู ุงููุทุฑ ูุงูุซูุฌ ุงูุฎููู. ูุนููุฉ ุชูุฑููุบ ููุชุงุฒุฉ.'},
          {id:'fir-1', brand:'Firemax', name:'Firemax FM501', size:'235/75R15', price:69.99, img:'https://fdflex.com/wp-content/uploads/2024/01/FM501_2.png', desc:'ุฅุทุงุฑ SUV ุงูุชุตุงุฏู ุจุซุจุงุช ุฌูุฏ ุนูู ุงูุทุฑู.'},
          {id:'dur-2', brand:'Duraturn', name:'Duraturn Travia A/T', size:'265/70R16', price:92.50, img:'https://cdn11.bigcommerce.com/s-e8i94i2k1a/images/stencil/1280x1280/products/58714/844891/duraturn-travia-at-b-aaa-1__48494.1719256293.jpg?c=2', desc:'ูุฏุฑุฉ ูุชุนุฏุฏุฉ ููุทุฑู ุงููุนุฑุฉ ูุงูุดุงุญูุงุช.'},
          {id:'bri-2', brand:'Bridgestone', name:'Bridgestone Dueler A/T Ascent', size:'275/60R20', price:189.00, img:'https://m.media-amazon.com/images/I/9116emC8QiL._AC_UF350,350_QL80_.jpg', desc:'ุชูุงุณู ููู ููุทุฑู ุงููุนุฑุฉ ูุน ุฑุงุญุฉ ุนูู ุงูุฃุณููุช.'},
          {id:'fir-2', brand:'Firemax', name:'Firemax FM316', size:'205/55R16', price:58.00, img:'https://www.tiremaxx.ca/public/upload/product/pattern_rc-upload-1688577203434-12.webp', desc:'ุฅุทุงุฑ ุฑูุงุจ ุงูุชุตุงุฏู.'}
        ],

        cart:[],

        // Question generation templates (Arabic)
        questionTemplates: {
          intents: [
            'ูู {subject} ุฌูุฏ ูู',
            'ููู ูุนูู {subject} ูู',
            'ูู ูุณุชุทูุน {subject} ุงูุชุนุงูู ูุน',
            'ูู {subject} ููุงุณุจ ูู',
            'ููู ุฃุฏุงุก {subject} ูู'
          ],
          contexts: [
            'ุงูููุงุฏุฉ ุงูููููุฉ ุนูู ุงูุทุฑู ุงูุณุฑูุนุฉ ูู ุญุฑุงุฑุฉ ุงูุฅูุงุฑุงุช',
            'ุญุฑูุฉ ุงููุฑูุฑ ูู ุงููุฏููุฉ ูุงูุชููู ุงููุชูุฑุฑ',
            'ุฑุญูุงุช ุงูุตุญุฑุงุก ุงูุทูููุฉ',
            'ุงูุทุฑู ุงููุจููุฉ ูุงูุฃูุทุงุฑ ุงููุชูุทุนุฉ',
            'ุงูุทุฑู ุงููุนุฑุฉ ูุงูุชุถุงุฑูุณ ุงูุตุนุจุฉ',
            'ุธุฑูู ุงูุตูู ุงูุญุงุฑุฉ',
            'ุงูุงุณุชุฎุฏุงู ุงููุฎุชูุท ุจูู ุงููุฏููุฉ ูุงูุทุฑู ุงูุณุฑูุนุฉ'
          ],
          subjects: [] // Generated dynamically per product
        },
        
        // Store generated questions per product
        productQuestions: {},

        async init(){
          // Load cart from Firestore (or localStorage as fallback)
          await this.loadCartFromFirestore();
          
          // Watch cart changes and sync to Firestore
          this.$watch('cart', () => {
            this.syncCartToFirestore();
          });
          
          // Initialize tire universe scores
          this.updateTireScores();
          
          // Set up watchers for CustomerMemory preferences
          if (window.CustomerMemory) {
            // Watch currency changes
            this.$watch('selectedCurrency', v => {
              localStorage.setItem('aa_currency', v);
              CustomerMemory.setCurrency(v);
            });
            
            // Watch brand filter changes
            this.$watch('filters.brand', v => {
              CustomerMemory.setBrandFilter(v);
            });
            
            // Watch bulk mode changes
            this.$watch('bulkMode', v => {
              CustomerMemory.setBulkMode(v);
            });
          } else {
            // Fallback to direct localStorage
            this.$watch('selectedCurrency', v => localStorage.setItem('aa_currency', v));
          }
          
          // Fetch exchange rates
          await this.fetchExchangeRates();
        },
        
        // Show welcome back message
        showWelcomeMessage(){
          if (!window.CustomerMemory) return;
          
          // Show welcome message after a short delay to ensure page is loaded
          setTimeout(() => {
            CustomerMemory.showWelcomeBack();
          }, 500);
        },
        
        // Track WhatsApp usage
        trackWhatsAppUsage(){
          if (window.CustomerMemory) {
            CustomerMemory.markWhatsAppUsed();
          }
        },
        
        async fetchExchangeRates(){
          try {
            const response = await fetch('/api/exchange-rates');
            const data = await response.json();
            if (data.rates) {
              this.exchangeRates = data.rates;
            }
          } catch (err) {
            console.error('Failed to fetch exchange rates:', err);
            // Keep using fallback rates already set
          }
        },
        
        convertPrice(usdPrice){
          if (this.selectedCurrency === 'USD') {
            return usdPrice;
          } else if (this.selectedCurrency === 'AED') {
            return usdPrice * this.exchangeRates.AED;
          }
          return usdPrice;
        },
        
        formatPrice(usdPrice){
          const converted = this.convertPrice(usdPrice);
          const symbol = this.currencySymbols[this.selectedCurrency] || '$';
          // AED and USD both use 2 decimal places
          return `${symbol}${converted.toFixed(2)}`;
        },

        brandProductCount(brandName){
          return this.products.filter(p => p.brand === brandName).length;
        },

        passengerBrandModels(brandName){
          const brand = this.passengerBrands.find(b => b.name === brandName);
          return brand ? brand.models : [];
        },

        filteredProducts(){
          return this.products.filter(p => {
            const brandMatch = !this.filters.brand || p.brand === this.filters.brand;
            const q = this.filters.query.trim().toLowerCase();
            const queryMatch = !q || (p.name + ' ' + p.size).toLowerCase().includes(q);
            return brandMatch && queryMatch;
          });
        },

        addToCart(p){
          // AUTH GATE: Require authentication before adding to cart
          if (!window.firebaseAuth?.currentUser) {
            window.location.href = '/auth.html';
            return;
          }
          
          const existing = this.cart.find(i => i.id === p.id);
          if (existing) existing.qty++;
          else this.cart.push({...p, qty:1});
          this.cartOpen = true;
        },

        subtotal(){
          return this.cart.reduce((sum, i) => sum + i.price * i.qty, 0);
        },
        
        // Cart Firestore sync functions
        async syncCartToFirestore(){
          try {
            const user = window.firebaseAuth?.currentUser;
            if (!user || !window.firebaseDB) return;
            
            const { doc, setDoc } = window.firebaseFirestoreAPI;
            const cartRef = doc(window.firebaseDB, 'carts', user.uid);
            await setDoc(cartRef, { items: this.cart }, { merge: true });
          } catch (err) {
            console.error('Failed to sync cart to Firestore:', err);
            // Fallback to localStorage on error
            localStorage.setItem('aa_cart', JSON.stringify(this.cart));
          }
        },
        
        async loadCartFromFirestore(){
          try {
            const user = window.firebaseAuth?.currentUser;
            if (!user || !window.firebaseDB) {
              // Not authenticated, try localStorage fallback
              const saved = localStorage.getItem('aa_cart');
              if (saved) this.cart = JSON.parse(saved);
              return;
            }
            
            const { doc, getDoc } = window.firebaseFirestoreAPI;
            const cartRef = doc(window.firebaseDB, 'carts', user.uid);
            const cartSnap = await getDoc(cartRef);
            
            if (cartSnap.exists() && cartSnap.data().items) {
              this.cart = cartSnap.data().items;
            }
          } catch (err) {
            console.error('Failed to load cart from Firestore:', err);
            // Fallback to localStorage on error
            const saved = localStorage.getItem('aa_cart');
            if (saved) this.cart = JSON.parse(saved);
          }
        },

        // Interactive Tire Universe Methods
        updateTireScores(){
          // Build new scores object to trigger Alpine reactivity
          const newScores = {};
          this.products.forEach(p => {
            newScores[p.id] = this.calculateProductScore(p);
          });
          
          // RANK SNAPPING: Normalize score spread and force minimum distance
          const sortedProducts = [...this.products].sort((a, b) => 
            (newScores[b.id] || 0) - (newScores[a.id] || 0)
          );
          
          // Force score separation: ensure minimum 8-point gaps between ranks
          const minGap = 8;
          for (let i = 1; i < sortedProducts.length; i++) {
            const prevScore = newScores[sortedProducts[i-1].id];
            const currScore = newScores[sortedProducts[i].id];
            
            if (prevScore - currScore < minGap) {
              // Adjust current score to maintain minimum gap
              newScores[sortedProducts[i].id] = prevScore - minGap;
            }
          }
          
          // Re-sort after adjustments
          sortedProducts.sort((a, b) => 
            (newScores[b.id] || 0) - (newScores[a.id] || 0)
          );
          
          // Assign ranks - build new object to trigger Alpine reactivity
          const newRanks = {};
          sortedProducts.forEach((p, index) => {
            newRanks[p.id] = index + 1; // Ranks 1-6
          });
          
          // Assign both new objects in single operations to trigger reactivity
          this.tireUniverse.scores = newScores;
          this.tireUniverse.ranks = newRanks;
        },

        calculateProductScore(product){
          const { drivingType, priority, drivingStyle } = this.tireUniverse;
          
          // NON-LINEAR AMPLIFICATION: Apply power curve to slider deltas from center
          const amplifyDelta = (sliderValue) => {
            const delta = sliderValue - 50; // Distance from center
            const sign = Math.sign(delta);
            const absDelta = Math.abs(delta);
            // Power curve: small movements get amplified more
            const amplified = sign * Math.pow(absDelta, 1.6);
            return 50 + amplified; // Return amplified slider position
          };
          
          const amplifiedDrivingType = amplifyDelta(drivingType);
          const amplifiedPriority = amplifyDelta(priority);
          const amplifiedDrivingStyle = amplifyDelta(drivingStyle);
          
          // DOMINANCE THRESHOLD: Check if any slider is ยฑ10 from center (increased sensitivity)
          const drivingTypeDelta = Math.abs(drivingType - 50);
          const priorityDelta = Math.abs(priority - 50);
          const drivingStyleDelta = Math.abs(drivingStyle - 50);
          
          const drivingTypeDominant = drivingTypeDelta >= 10;
          const priorityDominant = priorityDelta >= 10;
          const drivingStyleDominant = drivingStyleDelta >= 10;
          
          // Get price percentile (0-100)
          const prices = this.products.map(p => p.price);
          const minPrice = Math.min(...prices);
          const maxPrice = Math.max(...prices);
          const pricePercentile = maxPrice > minPrice 
            ? ((product.price - minPrice) / (maxPrice - minPrice)) * 100 
            : 50;
          
          // Brand category (performance tier)
          const brandTier = {
            'Bridgestone': 85,
            'Firemax': 45,
            'Duraturn': 60
          }[product.brand] || 50;
          
          // Keyword matching from description
          const desc = (product.desc || '').toLowerCase();
          const name = (product.name || '').toLowerCase();
          const text = desc + ' ' + name;
          
          // City vs Highway keywords (using AMPLIFIED slider value)
          const cityKeywords = ['city', 'urban', 'comfort', 'quiet', 'smooth', 'touring'];
          const highwayKeywords = ['highway', 'speed', 'stability', 'long', 'distance'];
          const cityScore = cityKeywords.filter(k => text.includes(k)).length * 20;
          const highwayScore = highwayKeywords.filter(k => text.includes(k)).length * 20;
          const drivingTypeScore = 100 - Math.abs(amplifiedDrivingType - (highwayScore - cityScore + 50));
          
          // Budget vs Performance - correlate with price percentile and brand (using AMPLIFIED value)
          const performanceIndicator = (pricePercentile * 0.6) + (brandTier * 0.4);
          const priorityScore = 100 - Math.abs(amplifiedPriority - performanceIndicator);
          
          // Quiet vs Aggressive keywords (using AMPLIFIED value)
          const quietKeywords = ['quiet', 'comfort', 'smooth', 'refined', 'touring'];
          const aggressiveKeywords = ['sport', 'performance', 'grip', 'traction', 'aggressive'];
          const quietScore = quietKeywords.filter(k => text.includes(k)).length * 20;
          const aggressiveScore = aggressiveKeywords.filter(k => text.includes(k)).length * 20;
          const drivingStyleScore = 100 - Math.abs(amplifiedDrivingStyle - (aggressiveScore - quietScore + 50));
          
          // DOMINANCE-BASED WEIGHTING
          let weights = { drivingType: 0.33, priority: 0.34, drivingStyle: 0.33 };
          
          if (drivingTypeDominant || priorityDominant || drivingStyleDominant) {
            // When a dimension is dominant, boost its weight significantly
            weights = { drivingType: 0.15, priority: 0.15, drivingStyle: 0.15 };
            
            if (drivingTypeDominant) weights.drivingType = 0.55;
            if (priorityDominant) weights.priority = 0.55;
            if (drivingStyleDominant) weights.drivingStyle = 0.55;
            
            // Normalize
            const totalWeight = weights.drivingType + weights.priority + weights.drivingStyle;
            weights.drivingType /= totalWeight;
            weights.priority /= totalWeight;
            weights.drivingStyle /= totalWeight;
          }
          
          // Weighted average with dynamic weights
          const finalScore = (drivingTypeScore * weights.drivingType) + 
                            (priorityScore * weights.priority) + 
                            (drivingStyleScore * weights.drivingStyle);
          
          return Math.max(0, Math.min(100, finalScore));
        },

        getPodiumSlotStyle(product){
          const rank = this.tireUniverse.ranks[product.id] || 3;
          
          // 6 FIXED PODIUM SLOTS using absolute positioning
          // Centered horizontally, different vertical positions
          // RTL: Mirrored left/right positions for ranks 2-3 and 4-6
          const containerWidth = 1000; // approximate podium stage width
          const cardWidth = 200;
          const centerX = (containerWidth - cardWidth) / 2;
          
          const podiumSlots = {
            // Tier 1 - Winner (#1) - Center, highest
            1: { 
              top: 80,
              left: centerX,
              scale: 1.25,
              opacity: 1.0,
              zIndex: 110,
              tier: 1,
              delay: 0.6 // Settles last
            },
            // Tier 2 - Runners-up (#2-3) - Mirrored for RTL
            2: { 
              top: 160,
              left: centerX + 240, // RTL: right position
              scale: 1.08,
              opacity: 0.95,
              zIndex: 108,
              tier: 2,
              delay: 0.3
            },
            3: { 
              top: 160,
              left: centerX - 240, // RTL: left position
              scale: 1.08,
              opacity: 0.95,
              zIndex: 108,
              tier: 2,
              delay: 0.3
            },
            // Tier 3 - Lower (#4-6) - Row at bottom, mirrored for RTL
            4: { 
              top: 400,
              left: centerX + 240, // RTL: right position
              scale: 0.90,
              opacity: 0.75,
              zIndex: 105,
              tier: 3,
              delay: 0
            },
            5: { 
              top: 400,
              left: centerX,
              scale: 0.90,
              opacity: 0.70,
              zIndex: 105,
              tier: 3,
              delay: 0
            },
            6: { 
              top: 400,
              left: centerX - 240, // RTL: left position
              scale: 0.90,
              opacity: 0.65,
              zIndex: 105,
              tier: 3,
              delay: 0
            }
          };
          
          const slot = podiumSlots[rank] || podiumSlots[3];
          
          // Enhanced glow for top 3
          let boxShadow = 'none';
          if (rank === 1) {
            boxShadow = '0 0 25px rgba(0, 224, 164, 0.7)';
          } else if (rank === 2 || rank === 3) {
            boxShadow = '0 0 15px rgba(0, 224, 164, 0.4)';
          }
          
          // Desaturate Tier 3
          const filter = slot.tier === 3 ? 'saturate(0.7) brightness(0.85)' : 'none';
          
          return {
            top: `${slot.top}px`,
            left: `${slot.left}px`,
            transform: `scale(${slot.scale})`,
            opacity: slot.opacity,
            zIndex: slot.zIndex,
            boxShadow: boxShadow,
            filter: filter,
            transitionDelay: `${slot.delay}s`
          };
        },

        getRankBadge(product){
          const rank = this.tireUniverse.ranks[product.id] || 3;
          
          const badges = {
            1: { text: '#1', bg: 'linear-gradient(135deg, #FFD700, #FFA500)', medal: '๐ฅ' },
            2: { text: '#2', bg: 'linear-gradient(135deg, #C0C0C0, #A8A8A8)', medal: '๐ฅ' },
            3: { text: '#3', bg: 'linear-gradient(135deg, #CD7F32, #8B4513)', medal: '๐ฅ' },
            4: { text: '#4', bg: 'linear-gradient(135deg, #708090, #556B2F)', medal: '' },
            5: { text: '#5', bg: 'linear-gradient(135deg, #FF8C00, #FF6347)', medal: '' },
            6: { text: '#6', bg: 'linear-gradient(135deg, #DC143C, #8B0000)', medal: '' }
          };
          
          return badges[rank] || badges[3];
        },

        getVerdictTextAr(product){
          const rank = this.tireUniverse.ranks[product.id] || 3;
          
          const verdicts = {
            1: { text: 'ุงูุฃูุถู ูุฃุณููุจ ููุงุฏุชู', color: '#059669' },
            2: { text: 'ุจุฏูู ููู ุฌุฏุงู', color: '#10B981' },
            3: { text: 'ููุงุณุจ ุจุดูู ููุจูู', color: '#F59E0B' },
            4: { text: 'ุบูุฑ ูุซุงูู ูุงุณุชุฎุฏุงูู', color: '#FB923C' },
            5: { text: 'ูุทุงุจูุฉ ุถุนููุฉ', color: '#EF4444' },
            6: { text: 'ุฎูุงุฑ ุฎุงุทุฆ ูููุงุฏุชู', color: '#991B1B' }
          };
          
          return verdicts[rank] || verdicts[3];
        },

        getProductExplanationAr(product){
          const score = this.tireUniverse.scores[product.id] || 50;
          
          // Only show explanation for highly aligned products
          if (score < 65) return '';
          
          const { drivingType, priority, drivingStyle } = this.tireUniverse;
          
          // Determine primary alignment (Arabic translations)
          const explanations = [];
          
          if (drivingType > 65) {
            explanations.push('ููุงุณุจ ุฃูุซุฑ ููููุงุฏุฉ ุนูู ุงูุทุฑู ุงูุณุฑูุนุฉ');
          } else if (drivingType < 35) {
            explanations.push('ููุงุณุจ ุฃูุซุฑ ููููุงุฏุฉ ูู ุงููุฏููุฉ');
          }
          
          if (priority > 65) {
            explanations.push('ูุชูุงูู ูุน ุงูุชุฑููุฒ ุนูู ุงูุฃุฏุงุก');
          } else if (priority < 35) {
            explanations.push('ูุชูุงูู ูุน ุฃููููุฉ ุงูููุฒุงููุฉ');
          }
          
          if (drivingStyle > 65) {
            explanations.push('ููุงุณุจ ููููุงุฏุฉ ุงูุฑูุงุถูุฉ');
          } else if (drivingStyle < 35) {
            explanations.push('ููุงุณุจ ููุฑุงุญุฉ ุงููุงุฏุฆุฉ');
          }
          
          // Return the most relevant explanation
          return explanations[0] || 'ูุชูุงูู ุฌูุฏุงู ูุน ุชูุถููุงุชู';
        },

        // Generate product subject for questions (Arabic)
        getProductSubject(product){
          // Use brand + model/name if available, otherwise "ูุฐุง ุงูุฅุทุงุฑ"
          if (product.brand && product.name) {
            const modelName = product.name.replace(product.brand, '').trim();
            return modelName ? `${product.brand} ${modelName}` : product.brand;
          }
          return 'ูุฐุง ุงูุฅุทุงุฑ';
        },

        // Generate 3 unique questions for a product
        generateQuestions(product){
          const subject = this.getProductSubject(product);
          const subjectWithSize = product.size ? `${subject} (${product.size})` : subject;
          
          // Create pool of all possible combinations
          const allCombinations = [];
          this.questionTemplates.intents.forEach(intent => {
            this.questionTemplates.contexts.forEach(context => {
              allCombinations.push({
                intent,
                context,
                question: intent.replace('{subject}', subjectWithSize) + ' ' + context + 'ุ'
              });
            });
          });
          
          // Shuffle all combinations
          const shuffled = allCombinations.sort(() => Math.random() - 0.5);
          
          // Pick 3 with no adjacent duplicate intents (with retry limit)
          const selected = [];
          for (let i = 0; i < shuffled.length && selected.length < 3; i++) {
            const candidate = shuffled[i];
            // Check if this intent was just used
            if (selected.length === 0 || selected[selected.length - 1].intent !== candidate.intent) {
              selected.push(candidate);
            }
          }
          
          // Fallback: if we couldn't find 3, just take first 3 (unlikely with 35 combinations)
          while (selected.length < 3 && selected.length < shuffled.length) {
            selected.push(shuffled[selected.length]);
          }
          
          return selected.map(s => s.question);
        },

        // Get or generate questions for a product
        getProductQuestions(product){
          if (!this.productQuestions[product.id]) {
            this.productQuestions[product.id] = this.generateQuestions(product);
          }
          return this.productQuestions[product.id];
        },

        // Refresh questions for a specific product
        refreshProductQuestions(product){
          this.productQuestions[product.id] = this.generateQuestions(product);
        },

        // Open AI chat with pre-filled question and product context
        openChatWithQuestion(question, product){
          const priceInfo = this.formatPrice(product.price);
          const context = `ูููุชุฌ ${this.getProductSubject(product)}${product.size ? ' (' + product.size + ')' : ''}${product.desc ? 'ุ ' + product.desc : ''} - ุงูุณุนุฑ: ${priceInfo}`;
          const fullMessage = `${question}\n\n[ูุนูููุงุช ุงูููุชุฌ: ${context}]`;
          
          // Open the AI chat widget
          const chatBtn = document.querySelector('.ai-chat-btn');
          const chatBox = document.querySelector('.ai-chat-box');
          if (chatBtn && chatBox) {
            chatBox.style.display = 'flex';
            chatBox.style.flexDirection = 'column';
            
            // Pre-fill the input and auto-send
            const chatInput = chatBox.querySelector('.ai-chat-input');
            const sendBtn = chatBox.querySelector('.ai-chat-send');
            if (chatInput && sendBtn) {
              chatInput.value = fullMessage;
              // Auto-send the message by clicking the send button
              sendBtn.click();
            }
          }
        },

        // send two emails with the standard template (orders/contact/brand inquiries)
        async sendTwoEmails(params){
          await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, {...params, to_email: 'Ilimot2012@gmail.com'});
          await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, {...params, to_email: params.customer_email || params.from_email});
        },

        // BRAND INQUIRY
        async sendBrandInquiry(brandName){
          const list = this.products.filter(p => p.brand === brandName);
          const lines = list.length
            ? list.map(p => `โข ${p.name} (${p.size}) โ $${p.price.toFixed(2)}`).join('\n')
            : 'ูุง ุชูุฌุฏ ููุชุฌุงุช ูุณุฌูุฉ ููุฐู ุงูุนูุงูุฉ ุญุชู ุงูุขู.';

          const params = {
            subject_line: `ุงุณุชูุณุงุฑ ุนูุงูุฉ โ ${brandName}`,
            from_name: 'ุฒุงุฆุฑ ุงููููุน',
            from_email: 'no-reply@aslamalteeba.netlify.app',
            customer_email: 'no-reply@aslamalteeba.netlify.app',
            message: `ุทูุจ ุงูุฒุงุฆุฑ ูุนูููุงุช ุนู ${brandName}.`,
            brand_name: brandName,
            brand_products: lines
          };

          try {
            await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, {...params, to_email: 'Ilimot2012@gmail.com'});
            alert('โ ุชู ุฅุฑุณุงู ุงูุงุณุชูุณุงุฑ! ุณูุชู ุงูุชูุงุตู ูุฑูุจุงู.');
          } catch (err){
            console.error(err);
            alert('โ ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุฅุฑุณุงู ุงูุงุณุชูุณุงุฑ: ' + (err?.text || err?.message || 'ุบูุฑ ูุนุฑูู'));
          }
        },

        // CONTACT
        async sendContact(){
          const params = {
            subject_line: 'ุชูุงุตู โ Aslama Alteeba',
            from_name: this.contact.name,
            from_email: this.contact.email,
            customer_email: this.contact.email,
            message: this.contact.message
          };
          try {
            await this.sendTwoEmails(params);
            alert('โ ุชู ุฅุฑุณุงู ุงูุฑุณุงูุฉ!');
            this.contact = {name:'',email:'',message:''};
          } catch (err){
            console.error(err);
            alert('โ ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุฅุฑุณุงู ุงูุฑุณุงูุฉ: ' + (err?.text || err?.message || 'ุบูุฑ ูุนุฑูู'));
          }
        },

        // ORDER
        async placeOrder(){
          if (this.cart.length===0) return;
          const lines = this.cart.map(i => `${i.qty}x ${i.name} (${i.size}) โ $${(i.price*i.qty).toFixed(2)}`).join('\n');
          const sub = this.subtotal(), vat=sub*0.05, total=sub+vat;
          const params = {
            subject_line: `ุทูุจ โ ${this.checkout.name}`,
            from_name: this.checkout.name,
            from_email: this.checkout.email,
            customer_email: this.checkout.email,
            message: 'ุชู ุฅูุดุงุก ุทูุจ ุฌุฏูุฏ ุนุจุฑ ุงููููุน (ูุถุน ุชุฌุฑูุจู).',
            order_lines: lines,
            order_subtotal: `$${sub.toFixed(2)}`,
            order_vat: `$${vat.toFixed(2)}`,
            order_total: `$${total.toFixed(2)}`,
            customer_phone: this.checkout.phone || 'N/A',
            customer_vehicle: this.checkout.vehicle || 'N/A'
          };
          try {
            await this.sendTwoEmails(params);
            alert('โ ุชู ุฅุฑุณุงู ุงูุทูุจ ุจูุฌุงุญ!');
            this.cart = [];
            this.cartOpen = false;
            this.checkout = {name:'',email:'',phone:'',vehicle:''};
          } catch(err){
            console.error(err);
            alert('โ ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุฅุฑุณุงู ุงูุทูุจ: ' + (err?.text || err?.message || 'ุบูุฑ ูุนุฑูู'));
          }
        },

        // INTRO EMAIL (uses dedicated template)
        async sendIntro(){
          this.introSuccess = false; this.introError = '';
          const params = {
            subject_line: 'ุทูุจ ุชุนุฑูู โ Aslama Alteeba',
            from_name: this.intro.name,
            from_email: this.intro.email,
            customer_email: this.intro.email,
            phone: this.intro.phone
          };
          try {
            await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_INTRO_TEMPLATE, {...params, to_email: 'Ilimot2012@gmail.com'});
            await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_INTRO_TEMPLATE, {...params, to_email: params.customer_email});
            this.introSuccess = true;
            this.intro = {name:'',email:'',phone:''};
          } catch(err){
            console.error(err);
            this.introError = 'ุฎุทุฃ: ' + (err?.text || err?.message || 'ุบูุฑ ูุนุฑูู');
          }
        },

        scrollChat(){
          const el = this.$refs.chatScroll;
          if (el) el.scrollTop = el.scrollHeight;
        },

        async sendChatMessage(){
          const content = this.chatInput.trim();
          if (!content || this.chatLoading) return;
          this.chatError = '';
          this.chatMessages.push({role:'user', content});
          this.chatInput = '';
          this.chatLoading = true;
          this.$nextTick(() => this.scrollChat());
          try {
            const response = await fetch('/api/chat', {
              method: 'POST',
              headers: {'Content-Type':'application/json'},
              body: JSON.stringify({message: content})
            });
            const data = await response.json().catch(() => ({}));
            if (!response.ok) {
              throw new Error(data?.error || data?.message || 'Failed to get AI response');
            }
            const reply = (data?.reply || '').trim() || 'ุดูุฑุงู ุนูู ุณุคุงูู. ุณูุชุงุจุน ุงููุฑูู ูุฑูุจุงู.';
            this.chatMessages.push({role:'assistant', content: reply});
          } catch(err) {
            const msg = err?.message || 'ุงูุฏุฑุฏุดุฉ ุงูุฐููุฉ ุบูุฑ ูุชุงุญุฉ ุญุงููุงู.';
            this.chatError = msg;
            this.chatMessages.push({role:'assistant', content: 'ุนุฐุฑุงูุ ุงููุณุงุนุฏ ุงูุฐูู ุบูุฑ ูุชุงุญ ุญุงููุงู. ูุฑุฌู ุงููุญุงููุฉ ูุงุญูุงู.'});
          } finally {
            this.chatLoading = false;
            this.$nextTick(() => this.scrollChat());
          }
        }
      }
    }
  </script>
  <script src="/chat.js" defer></script>
  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
  import {
    getAuth,
    onAuthStateChanged,
    createUserWithEmailAndPassword,
    signInWithEmailAndPassword,
    signOut,
    sendEmailVerification,
    GoogleAuthProvider,
    signInWithPopup,
    setPersistence,
    browserLocalPersistence
  } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
  import {
    getFirestore,
    doc,
    getDoc,
    setDoc
  } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyD5vnHsA23Uw3snDvu4qvqSh5wgRtDTMSc",
    authDomain: "aslamalteeba-2.firebaseapp.com",
    projectId: "aslamalteeba-2",
    storageBucket: "aslamalteeba-2.firebasestorage.app",
    messagingSenderId: "1004820564683",
    appId: "1:1004820564683:web:9833a031e3fa62a365e94e"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // ๐ Make "stay signed in" the default
  setPersistence(auth, browserLocalPersistence);

  // ๐ Expose auth globally so chat.js can see it later
  window.firebaseAuth = auth;
  window.firebaseAuthAPI = {
    createUserWithEmailAndPassword,
    signInWithEmailAndPassword,
    signOut,
    sendEmailVerification,
    GoogleAuthProvider,
    signInWithPopup,
    onAuthStateChanged
  };

  // ๐ Expose Firestore globally for cart sync
  window.firebaseDB = db;
  window.firebaseFirestoreAPI = {
    doc,
    getDoc,
    setDoc
  };

  // Auth state management
  const signInBtn = document.getElementById("authSignInBtn");
  const signOutBtn = document.getElementById("authSignOutBtn");

  onAuthStateChanged(auth, async (user) => {
    console.log("AUTH STATE:", user ? user.email : "SIGNED OUT");
    
    if (user) {
      // User is signed in - show sign out, hide sign in
      signInBtn.style.display = "none";
      signOutBtn.style.display = "block";
      
      // Load cart from Firestore when user signs in
      const appStateElement = document.querySelector('[x-data]');
      if (appStateElement && appStateElement.__x) {
        const appData = appStateElement.__x.$data;
        if (appData && typeof appData.loadCartFromFirestore === 'function') {
          await appData.loadCartFromFirestore();
        }
      }
    } else {
      // User is signed out - show sign in, hide sign out
      signInBtn.style.display = "block";
      signOutBtn.style.display = "none";
      
      // Clear cart when user signs out
      const appStateElement = document.querySelector('[x-data]');
      if (appStateElement && appStateElement.__x) {
        const appData = appStateElement.__x.$data;
        if (appData && Array.isArray(appData.cart)) {
          appData.cart = [];
        }
      }
    }
  });

  // Sign out handler
  signOutBtn.addEventListener("click", async () => {
    try {
      await signOut(auth);
    } catch (err) {
      console.error("Sign out error:", err);
    }
  });
</script>
  
  <!-- Convert phone number digits to Persian numerals -->
  <script>
    (function() {
      const persianDigits = ['ฐ', 'ฑ', 'ฒ', 'ณ', 'ด', 'ต', 'ถ', 'ท', 'ธ', 'น'];
      const phoneEl = document.getElementById('phone-display');
      if (phoneEl) {
        const text = phoneEl.textContent;
        const persianText = text.replace(/\d/g, digit => persianDigits[digit]);
        phoneEl.textContent = persianText;
      }
    })();
  </script>
</body>
</html>
